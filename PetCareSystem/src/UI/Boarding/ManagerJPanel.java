/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JPanel.java to edit this template
 */
package UI.Boarding;

import Business.Enterprise.Enterprise;
import Business.Enterprise.PetBoardingEnterprise;
import Business.Organization.Organization;
import Business.Pet.BoardingRecordDirectory;
import Business.Pet.Pet;
import Business.Pet.PetBoardingRecord;
import Business.Petsystem;
import Business.UserAccount.UserAccount;
import Business.WorkQueue.HealthCareCheckRequest;
import Business.WorkQueue.WorkRequest;
import java.awt.CardLayout;
import java.util.ArrayList;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.table.DefaultTableModel;
import Business.PetBoardingOrganization.CustomerService;
import java.text.SimpleDateFormat;

/**
 *
 * @author hanlinyao
 */
public class ManagerJPanel extends javax.swing.JPanel {
    
    private JPanel userProcessContainer;
    private UserAccount account;
    private Organization organization;
    private Enterprise enterprise;
    private Petsystem system;
    
    private final SimpleDateFormat FULL_DATE_FORMAT = new SimpleDateFormat("EEE MMM dd HH:mm:ss zzz yyyy");
    private final SimpleDateFormat YEAR_DATE_FORMAT = new SimpleDateFormat("yyyy");

    /**
     * Creates new form ManageJPanel
     */
   public ManagerJPanel(JPanel userProcessContainer, UserAccount account, 
                             Organization organization, Enterprise enterprise, Petsystem system) {
        
        this.userProcessContainer = userProcessContainer;
        this.account = account;
        this.organization = organization;
        this.enterprise = enterprise;
        this.system = system;
        initComponents();
        
        // ÂàùÂßãÂåñË°®Ê†º
        populateTable();
         
       
      
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jLabel1 = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        jTable1 = new javax.swing.JTable();
        btnView = new javax.swing.JButton();
        btnSend = new javax.swing.JButton();
        btnLogout = new javax.swing.JButton();
        jSeparator1 = new javax.swing.JSeparator();

        setBackground(new java.awt.Color(204, 255, 204));

        jLabel1.setFont(new java.awt.Font("Helvetica Neue", 1, 18)); // NOI18N
        jLabel1.setText("Welcome to Pet Boarding Manager Work Area");

        jTable1.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Record ID", "Species", "Breakfast", "Lunch", "Dinner", "Poop", "Mood", "Symptom", "Message"
            }
        ));
        jScrollPane1.setViewportView(jTable1);

        btnView.setText("View Details");
        btnView.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnViewActionPerformed(evt);
            }
        });

        btnSend.setText("Send to Customer service");
        btnSend.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSendActionPerformed(evt);
            }
        });

        btnLogout.setText("Logout");
        btnLogout.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnLogoutActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(15, 15, 15)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(jSeparator1, javax.swing.GroupLayout.PREFERRED_SIZE, 809, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 809, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jLabel1)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(btnLogout)))
                .addContainerGap(33, Short.MAX_VALUE))
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addGap(98, 98, 98)
                .addComponent(btnView)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(btnSend)
                .addGap(173, 173, 173))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap(27, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(btnLogout))
                .addGap(18, 18, 18)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 246, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(26, 26, 26)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnSend)
                    .addComponent(btnView))
                .addGap(18, 18, 18)
                .addComponent(jSeparator1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(257, 257, 257))
        );
    }// </editor-fold>//GEN-END:initComponents

    private void btnSendActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSendActionPerformed
        // TODO add your handling code here:
        int selectedRow = jTable1.getSelectedRow();
        if (selectedRow < 0) {
            JOptionPane.showMessageDialog(this, "Please select a record to send to the customer service.", "Warning", JOptionPane.WARNING_MESSAGE);
            return;
        }

        // 1. Ëé∑ÂèñÈÄâ‰∏≠ÁöÑ Record ID
        String recordId = (String) jTable1.getValueAt(selectedRow, 0);
            PetBoardingRecord selectedRecord = findRecordById(recordId);
        Pet pet = (selectedRecord != null) ? selectedRecord.getPet() : null;

        if (pet == null) {
            JOptionPane.showMessageDialog(this, "Error: Unable to find the relevant pet information based on the record ID.", "Warning", JOptionPane.ERROR_MESSAGE);
            return;
        }

        // 2. Êü•ÊâæÁõÆÊ†á Customer Service Organization (FrontDeskOrganization)
        Organization targetOrg = findCustomerServiceOrganization();

        if (targetOrg == null) {
             JOptionPane.showMessageDialog(this, "The \"Customer Service\" organization was not found, so the request could not be sent.", "warning", JOptionPane.ERROR_MESSAGE);
             return;
        }
        for (WorkRequest wr : targetOrg.getWorkQueue().getWorkRequestList()) {
        if (wr instanceof HealthCareCheckRequest) {
            HealthCareCheckRequest existing = (HealthCareCheckRequest) wr;
            if (recordId.equals(existing.getBoardingRecordId())) {
                JOptionPane.showMessageDialog(this, 
                    "Record [" + recordId + "] has already been sent to Customer Service.", 
                    "Info", JOptionPane.INFORMATION_MESSAGE);
                return;  // Â∑≤Â≠òÂú®ÔºåÁõ¥Êé•ËøîÂõû
            }
        }
    }
        // ‚≠ê‚≠ê Ê≠•È™§ 2ÔºöÊü•Êâæ‰∏éËØ•ËÆ∞ÂΩïÁõ∏ÂÖ≥ÁöÑ HealthCareCheckRequestÔºå‰ª•Ëé∑Âèñ Symptom
    HealthCareCheckRequest sourceRequest = null;
    if (organization.getWorkQueue() != null) {
        for (WorkRequest wr : organization.getWorkQueue().getWorkRequestList()) {
            if (wr instanceof HealthCareCheckRequest) {
                HealthCareCheckRequest hcr = (HealthCareCheckRequest) wr;
                // ‰ΩøÁî®Êàë‰ª¨‰πãÂâç‰øÆÂ§çÁöÑ BoardingRecordId Á≤æÁ°ÆÂåπÈÖç
                if (recordId.equals(hcr.getBoardingRecordId())) { 
                    sourceRequest = hcr;
                    break;
                }
            }
        }
    }

        // 3. ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑ Work Request (‰ΩøÁî® HealthCareCheckRequest ‰Ωú‰∏∫ÈÄöÁî®ËØ∑Ê±ÇÁ±ªÂûã)
        // ÂÆûÈôÖ‰∏öÂä°‰∏≠ÔºåÂèØËÉΩÈúÄË¶ÅÂàõÂª∫‰∏Ä‰∏™‰∏ìÈó®ÁöÑ CustomerServiceRequest Á±ª
        HealthCareCheckRequest csRequest = new HealthCareCheckRequest();
        csRequest.setMessage("Manager review needed for Record ID: " + recordId);
        csRequest.setSender(account);
        csRequest.setReceiver(null); // ÂèëÈÄÅÂà∞ÈòüÂàó
        csRequest.setStatus("Manager Escalate - Pending CS Review");
        csRequest.setBoardingRecordId(recordId); // ÂÖ≥ËÅîËÆ∞ÂΩï ID
        csRequest.setPet(pet);
        // ‚≠ê‚≠ê‚≠ê Ê†∏ÂøÉ‰øÆÂ§çÔºöËÆæÁΩÆ Symptom Â≠óÊÆµ
    if (sourceRequest != null) {
        // ‰ªéÂéüÂßãËØ∑Ê±Ç‰∏≠ÁªßÊâøÁóáÁä∂
        csRequest.setSymptom(sourceRequest.getSymptom());
    } else {
        // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂéüÂßãËØ∑Ê±ÇÔºåÂèØ‰ª•ÊèêÁ§∫ Manager ËæìÂÖ•
        String newSymptom = JOptionPane.showInputDialog(this, "Please enter the symptoms that you would like to report to the customer service:", "Manager update request", JOptionPane.QUESTION_MESSAGE);
        if (newSymptom == null || newSymptom.trim().isEmpty()) {
             newSymptom = "Manager Escalation - No specific symptom recorded.";
        }
        csRequest.setSymptom(newSymptom);
    }
        // 4. Â∞ÜËØ∑Ê±ÇÊ∑ªÂä†Âà∞ÁõÆÊ†áÁªÑÁªáÁöÑ Work Queue
        targetOrg.getWorkQueue().getWorkRequestList().add(csRequest);

        JOptionPane.showMessageDialog(this, 
            "record [" + recordId + "] send to Customer Service„ÄÇ", 
            "Success", JOptionPane.INFORMATION_MESSAGE);

        // 5. Âà∑Êñ∞Ë°®Ê†ºÔºàÂèØÈÄâÔºâ
         populateTable();
    }//GEN-LAST:event_btnSendActionPerformed

    private void btnViewActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnViewActionPerformed
        // TODO add your handling code here:
        // 1. Ê£ÄÊü•ÊòØÂê¶ÈÄâ‰∏≠‰∫ÜË°®Ê†º‰∏≠ÁöÑ‰∏ÄË°å
    int selectedRow = jTable1.getSelectedRow();
    if (selectedRow < 0) {
        JOptionPane.showMessageDialog(this, "Please choice one record", "warning", JOptionPane.WARNING_MESSAGE);
        return;
    }

    // 2. Ëé∑ÂèñÈÄâ‰∏≠Ë°åÁöÑ Record ID
    String recordId = (String) jTable1.getValueAt(selectedRow, 0);

    // 3. Ê†πÊçÆ Record ID Êü•ÊâæÂØπÂ∫îÁöÑ PetBoardingRecord
    PetBoardingRecord selectedRecord = findRecordById(recordId);

    if (selectedRecord == null) {
        JOptionPane.showMessageDialog(this, "No corresponding record was found.", "warning", JOptionPane.ERROR_MESSAGE);
        return;
    }

    // 4. ÂàõÂª∫ ManagerViewJPanel Âπ∂‰º†ÈÄíÊï∞ÊçÆ
    ManagerViewJPanel viewPanel = new ManagerViewJPanel(
            userProcessContainer, 
            account, 
            organization, 
            enterprise, 
            system
    );

    // 5. Âä†ËΩΩËÆ∞ÂΩïËØ¶ÊÉÖ
    viewPanel.loadRecordDetails(selectedRecord);

    // 6. Ê∑ªÂä†Âà∞ÂÆπÂô®Âπ∂ÂàáÊç¢ÊòæÁ§∫
    userProcessContainer.add("ManagerViewJPanel", viewPanel);
    CardLayout layout = (CardLayout) userProcessContainer.getLayout();
    layout.next(userProcessContainer);
}

// ‚≠ê ËæÖÂä©ÊñπÊ≥ïÔºöÊ†πÊçÆ Record ID Êü•Êâæ PetBoardingRecord
private PetBoardingRecord findRecordById(String recordId) {
    System.out.println("=== DEBUG findRecordById ===");
    System.out.println("Looking for BoardingRecord with ID: " + recordId);
    System.out.println("System: " + system);
    
    if (system == null) {
        System.out.println("‚ùå System is NULL!");
        return null;
    }
    
    // ÈÅçÂéÜÊâÄÊúâ Network
    if (system.getNetworkList() != null) {
        System.out.println("Network count: " + system.getNetworkList().size());
        
        for (Business.Network.Network network : system.getNetworkList()) {
            System.out.println("  Network: " + network.getName());
            
            // ÈÅçÂéÜËØ• Network ‰∏≠ÁöÑÊâÄÊúâ Enterprise
            if (network.getEnterpriseDirectory() != null) {
                for (Enterprise ent : network.getEnterpriseDirectory().getEnterpriseList()) {
                    System.out.println("    Enterprise: " + ent.getName() + " [" + ent.getClass().getSimpleName() + "]");
                    
                    // Âè™Â§ÑÁêÜ PetBoardingEnterprise
                    if (ent instanceof PetBoardingEnterprise) {
                        PetBoardingEnterprise boardingEnt = (PetBoardingEnterprise) ent;
                        BoardingRecordDirectory recordDirectory = boardingEnt.getBoardingRecordDirectory();
                        
                        if (recordDirectory != null && recordDirectory.getRecordList() != null) {
                            System.out.println("    Total records: " + recordDirectory.getRecordList().size());
                            
                            for (PetBoardingRecord record : recordDirectory.getRecordList()) {
                                System.out.println("      - Record ID: " + record.getRecordId());
                                
                                if (record.getRecordId().equals(recordId)) {
                                    System.out.println("    ‚úÖ Found record: " + recordId);
                                    return record;
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    
    System.out.println("‚ùå Record not found: " + recordId);
    return null;

    }//GEN-LAST:event_btnViewActionPerformed

    private void btnLogoutActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnLogoutActionPerformed
        // TODO add your handling code here:
        java.awt.Component comp = this;

        // Âêë‰∏äÈÅçÂéÜÁªÑ‰ª∂Ê†ëÔºåÁõ¥Âà∞ÊâæÂà∞ MainJFrame
        while (comp != null && !(comp instanceof UI.admin.MainJFrame)) {
            comp = comp.getParent();
        }

        if (comp instanceof UI.admin.MainJFrame) {
            // ‚≠ê ÂÖ≥ÈîÆ‰øÆÊ≠£ÔºöË∞ÉÁî®Êñ∞ÁöÑÂÖ¨ÂÖ±‰ª£ÁêÜÊñπÊ≥ï
            ((UI.admin.MainJFrame) comp).triggerLogout();
        } else {
            // Êâæ‰∏çÂà∞ MainJFrameÔºåÊâßË°åÂêéÂ§áÊñπÊ°à
            if (userProcessContainer != null) {
                userProcessContainer.removeAll();
                userProcessContainer.revalidate();
                userProcessContainer.repaint();
            }
        }
    }//GEN-LAST:event_btnLogoutActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnLogout;
    private javax.swing.JButton btnSend;
    private javax.swing.JButton btnView;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JSeparator jSeparator1;
    private javax.swing.JTable jTable1;
    // End of variables declaration//GEN-END:variables

    private void populateTable() {
        DefaultTableModel model = (DefaultTableModel) jTable1.getModel();
        model.setRowCount(0);
        
        if (!(enterprise instanceof PetBoardingEnterprise)) {
            return;
        }

        PetBoardingEnterprise boardingEnt = (PetBoardingEnterprise) this.enterprise;
        BoardingRecordDirectory recordDirectory = boardingEnt.getBoardingRecordDirectory();

        // ÂÅáËÆæ Manager ÂÖ≥Ê≥®ÁöÑÊòØ BoardingServiceOrganization ÁöÑ WorkQueueÔºåÁî®‰∫éËé∑ÂèñÂÅ•Â∫∑ËØ∑Ê±Ç
        // Organization boardingServiceOrg = organization; // ÂÅáËÆæ‰º†ÂÖ•ÁöÑ organization Â∞±ÊòØ BoardingServiceOrganization

        if (recordDirectory != null && recordDirectory.getRecordList() != null) {
            for (PetBoardingRecord record : recordDirectory.getRecordList()) {
                // ÁªèÁêÜÈÄöÂ∏∏Âè™ÁúãÊú™ÂÆåÊàêÁöÑËÆ∞ÂΩï
                if ("Checked In".equals(record.getStatus()) 
                    || "Pending Check-out".equals(record.getStatus())
                    || "Pending Check-in".equals(record.getStatus())) {
                    
                    Pet pet = record.getPet();
                    String notes = record.getNotes();
                    
                    // 1. Êü•ÊâæÁõ∏ÂÖ≥ÁöÑ HealthCareCheckRequestÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
                HealthCareCheckRequest activeRequest = null;
                if (organization.getWorkQueue() != null) {
                    for (WorkRequest wr : organization.getWorkQueue().getWorkRequestList()) {
                        if (wr instanceof HealthCareCheckRequest) {
                            HealthCareCheckRequest hcr = (HealthCareCheckRequest) wr;
                            
                            // üåü ‰øÆÂ§çÂêéÁöÑÊ†∏ÂøÉÈÄªËæëÔºö‰ΩøÁî® BoardingRecordId Á≤æÁ°ÆÂåπÈÖç
                            if (record.getRecordId().equals(hcr.getBoardingRecordId())) {
                                activeRequest = hcr;
                                break;
                            }
                        }
                    }
                }

                    Object[] row = new Object[9];
                    
                    // Record ID, Species
                    row[0] = record.getRecordId();
                    row[1] = (pet != null) ? pet.getSpecies() : "N/A";
                    
                    // ‚≠ê Daily Care (ÁÆÄÂåñÂ§ÑÁêÜÔºöÂ¶ÇÊûú Notes ÈùûÁ©∫ÔºåÂÅáËÆæÊúâËÆ∞ÂΩï)
                    boolean hasNotes = notes != null && notes.contains("Daily Care Log");
                    String logSymbol = hasNotes ? "‚úîÔ∏è" : "---";

                    row[2] = logSymbol; // Breakfast
                    row[3] = logSymbol; // Lunch
                    row[4] = logSymbol; // Dinner
                    row[5] = logSymbol; // Poop
                    row[6] = hasNotes ? "Normal" : "---"; // Mood (ÁÆÄÂåñ‰∏∫ Normal if logged)
                    
                    // Symptom, Message (Êù•Ëá™ Health Request)
                    row[7] = (activeRequest != null && activeRequest.getSymptom() != null) ? activeRequest.getSymptom() : "";
                    row[8] = (activeRequest != null) ? activeRequest.getMessage() : "";

                    model.addRow(row);
                }
            }
        }
    }
    
    public void refreshTable() {
        populateTable();
    }
    
    // ‚≠ê ËæÖÂä©ÊñπÊ≥ïÔºöÊü•ÊâæÁõÆÊ†á Customer Service Organization (FrontDeskOrganization)
    private Organization findCustomerServiceOrganization() {
    for (Organization org : enterprise.getOrganizationDirectory().getOrganizationList()) {
        // ÈÄöËøáÁ±ªÂêçÂà§Êñ≠
        if (org instanceof Business.PetBoardingOrganization.CustomerService) {
            return org;
        }
        // ÊàñËÄÖÈÄöËøáÁªÑÁªáÂêçÁß∞Âà§Êñ≠
        // if (org.getName().contains("Customer Service")) {
        //     return org;
        // }
    }
    return null;
    }

   
    
    
        
    }
        
       
    
        

